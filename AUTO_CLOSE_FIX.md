# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Ç–∏–∫–µ—Ç–æ–≤

## ‚ùå –ü—Ä–æ–±–ª–µ–º–∞:

–°–∏—Å—Ç–µ–º–∞ –ø—ã—Ç–∞–ª–∞—Å—å –∑–∞–∫—Ä—ã—Ç—å **—Å—Ç–∞—Ä—ã–µ —Ç–∏–∫–µ—Ç—ã**, —É –∫–æ—Ç–æ—Ä—ã—Ö —Ç–µ–º—ã —Ñ–æ—Ä—É–º–∞ **—É–∂–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç**:

```
üîí Ticket auto-closed for user 1335809045 due to inactivity
‚ùå Failed to auto-close ticket: message thread not found
üîí Ticket auto-closed for user 6194004930 due to inactivity
‚ùå Failed to auto-close ticket: message thread not found
... (100+ —Ç–∞–∫–∏—Ö –æ—à–∏–±–æ–∫)
```

**–ü—Ä–∏—á–∏–Ω–∞:**
- –¢–µ–º—ã —Ñ–æ—Ä—É–º–∞ –±—ã–ª–∏ —É–¥–∞–ª–µ–Ω—ã/–∑–∞–∫—Ä—ã—Ç—ã –≤—Ä—É—á–Ω—É—é –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º–∏
- –ù–æ —Ç–∏–∫–µ—Ç—ã –≤ –ë–î –æ—Å—Ç–∞–ª–∏—Å—å —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "open"
- –°–∏—Å—Ç–µ–º–∞ –ø—ã—Ç–∞–ª–∞—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ç–µ–º—É ‚Üí –æ—à–∏–±–∫–∞

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ:

### 1. Graceful –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏

–¢–µ–ø–µ—Ä—å –µ—Å–ª–∏ —Ç–µ–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ - **—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ**, –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º –∫–∞–∫ debug:

```python
try:
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
    await bot.send_message(...)
except Exception as exc:
    if "message thread not found" in str(exc).lower():
        logger.debug(f"Thread already closed manually")  # ‚Üê Debug, –Ω–µ error!
    else:
        logger.warning(f"Other error: {exc}")
```

### 2. –¢–∏–∫–µ—Ç –≤—Å–µ —Ä–∞–≤–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤ –ë–î

–î–∞–∂–µ –µ—Å–ª–∏ —Ç–µ–º–∞ —Ñ–æ—Ä—É–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, **—Ç–∏–∫–µ—Ç –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö**:

```python
# –°–Ω–∞—á–∞–ª–∞ –∑–∞–∫—Ä—ã–≤–∞–µ–º –≤ –ë–î
await auto_close_ticket(user_id)

# –ü–æ—Ç–æ–º –ø—ã—Ç–∞–µ–º—Å—è –∑–∞–∫—Ä—ã—Ç—å –≤ —Ñ–æ—Ä—É–º–µ (–º–æ–∂–µ—Ç –Ω–µ –ø–æ–ª—É—á–∏—Ç—å—Å—è - –Ω–∏—á–µ–≥–æ —Å—Ç—Ä–∞—à–Ω–æ–≥–æ)
try:
    await bot.close_forum_topic(...)
except:
    pass  # –¢–µ–º–∞ —É–∂–µ –∑–∞–∫—Ä—ã—Ç–∞ - –æ–∫
```

### 3. –ß–∏—Å—Ç—ã–µ –ª–æ–≥–∏

**–ë—ã–ª–æ:**
```
‚ùå Failed to auto-close ticket for user 1335809045: message thread not found
‚ùå Failed to auto-close ticket for user 6194004930: message thread not found
‚ùå Failed to auto-close ticket for user 1987569860: message thread not found
... (—Å–ø–∞–º)
```

**–°—Ç–∞–ª–æ:**
```
üîí Ticket auto-closed for user 1335809045 due to inactivity
‚úÖ Thread 123 already closed for user 1335809045  ‚Üê Debug —É—Ä–æ–≤–µ–Ω—å
```

---

## üéØ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–µ–ø–µ—Ä—å:

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –¢–µ–º–∞ —Ñ–æ—Ä—É–º–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

```
1. –°–∏—Å—Ç–µ–º–∞: "–ü–æ—Ä–∞ –∑–∞–∫—Ä—ã—Ç—å —Ç–∏–∫–µ—Ç user 123"
2. –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤ –ë–î ‚úÖ
3. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç ‚úÖ
4. –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ç–µ–º—É —Ñ–æ—Ä—É–º–∞ ‚úÖ
5. –õ–æ–≥–∏: "‚úÖ Ticket auto-closed successfully"
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –¢–µ–º–∞ —Ñ–æ—Ä—É–º–∞ —É–∂–µ –∑–∞–∫—Ä—ã—Ç–∞

```
1. –°–∏—Å—Ç–µ–º–∞: "–ü–æ—Ä–∞ –∑–∞–∫—Ä—ã—Ç—å —Ç–∏–∫–µ—Ç user 456"
2. –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤ –ë–î ‚úÖ
3. –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Üí "thread not found"
4. –õ–æ–≥–∏: "Thread already closed manually" (debug)
5. –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–∫—Ä—ã—Ç—å —Ç–µ–º—É ‚Üí "thread not found"
6. –õ–æ–≥–∏: "Thread already closed" (debug)
7. –¢–∏–∫–µ—Ç –≤—Å–µ —Ä–∞–≤–Ω–æ –∑–∞–∫—Ä—ã—Ç –≤ –ë–î ‚úÖ
```

---

## üìä –¢–µ–ø–µ—Ä—å –≤ –ª–æ–≥–∞—Ö:

### Debug —É—Ä–æ–≤–µ–Ω—å (–Ω–µ –º–µ—à–∞–µ—Ç):
```bash
docker-compose logs bot | grep "already closed"

# –ü–æ–∫–∞–∂–µ—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω DEBUG
Thread 123 already closed for user 698471795
```

### Info —É—Ä–æ–≤–µ–Ω—å (–≤–∞–∂–Ω–æ–µ):
```bash
docker-compose logs bot | grep "auto-closed successfully"

# –ü–æ–∫–∞–∂–µ—Ç —É—Å–ø–µ—à–Ω—ã–µ –∑–∞–∫—Ä—ã—Ç–∏—è
‚úÖ Ticket auto-closed successfully for user 698471795
```

### Error —É—Ä–æ–≤–µ–Ω—å (—Ç–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã):
```bash
docker-compose logs bot | grep "ERROR"

# –¢–µ–ø–µ—Ä—å –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "message thread not found"
# –¢–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω—ã–µ –æ—à–∏–±–∫–∏
```

---

## üßπ –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Ç–∏–∫–µ—Ç–æ–≤:

–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ **–æ—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ —Ç–∏–∫–µ—Ç—ã** –≤ –ë–î:

```bash
docker-compose exec bot python -c "
import asyncio
from database import get_db_pool

async def cleanup():
    pool = await get_db_pool()
    async with pool.acquire() as conn:
        # –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Ç–∏–∫–µ—Ç—ã —Å—Ç–∞—Ä—à–µ 24 —á–∞—Å–æ–≤
        result = await conn.execute('''
            UPDATE tickets 
            SET status = 'closed' 
            WHERE status = 'open' 
            AND last_message_time < NOW() - INTERVAL '24 hours'
        ''')
        print(f'‚úÖ Closed old tickets: {result}')

asyncio.run(cleanup())
"
```

---

## üéä –ò—Ç–æ–≥:

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚ùå 100+ –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö
- ‚ùå –°–ø–∞–º "Failed to auto-close"
- ‚ùå –¢–∏–∫–µ—Ç—ã –æ—Å—Ç–∞–≤–∞–ª–∏—Å—å –æ—Ç–∫—Ä—ã—Ç—ã–º–∏ –≤ –ë–î

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚úÖ –ß–∏—Å—Ç—ã–µ –ª–æ–≥–∏
- ‚úÖ Graceful –æ–±—Ä–∞–±–æ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö —Ç–µ–º
- ‚úÖ –¢–∏–∫–µ—Ç—ã –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è –≤ –ë–î –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ
- ‚úÖ Debug –ª–æ–≥–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

---

## üöÄ –ü—Ä–∏–º–µ–Ω–µ–Ω–æ!

```bash
docker-compose restart bot
```

**üéâ –ë–æ–ª—å—à–µ –Ω–∏–∫–∞–∫–∏—Ö –æ—à–∏–±–æ–∫ "message thread not found"! üéâ**

