# 🔄 Как работает ИИ-Ассистент

## Схема работы

```
┌─────────────────────────────────────────────────────────────────┐
│                     КЛИЕНТ СОЗДАЕТ ТИКЕТ                        │
│                                                                 │
│  Клиент: "Как пополнить баланс?"                               │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                   БОТ ПОЛУЧАЕТ СООБЩЕНИЕ                        │
│                                                                 │
│  • Создается тикет в базе данных                               │
│  • Сообщение отправляется в чат поддержки                      │
│  • human_responded = FALSE                                      │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│              ИИ АВТОМАТИЧЕСКИ ОТВЕЧАЕТ (1-3 сек)               │
│                                                                 │
│  ИИ: "Чтобы пополнить баланс:                                  │
│       1. Перейдите в раздел Профиль                            │
│       2. Нажмите кнопку Пополнить                              │
│       3. Выберите способ: Stars, Toncoin или Gifts"            │
│                                                                 │
│  • ai_responded = TRUE                                          │
│  • Клиент НЕ ВИДИТ что это ИИ!                                │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                  КЛИЕНТ ЗАДАЕТ УТОЧНЕНИЕ                        │
│                                                                 │
│  Клиент: "А какой способ самый выгодный?"                      │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│         ИИ СНОВА ОТВЕЧАЕТ (пока human_responded = FALSE)       │
│                                                                 │
│  ИИ: "Самый выгодный способ - через Подарки или Toncoin:       │
│       • Подарки: +20% бонус                                    │
│       • Toncoin: +10% бонус"                                   │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│              ОПЕРАТОР ВИДИТ ПЕРЕПИСКУ И ОТВЕЧАЕТ               │
│                                                                 │
│  Оператор: "Добрый день! Могу помочь с пополнением?"          │
│                                                                 │
│  • human_responded = TRUE                                       │
│  • ИИ АВТОМАТИЧЕСКИ ОТКЛЮЧАЕТСЯ                                │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│          КЛИЕНТ ПРОДОЛЖАЕТ ОБЩЕНИЕ С ОПЕРАТОРОМ                │
│                                                                 │
│  • ИИ больше не отвечает                                       │
│  • Оператор полностью контролирует диалог                      │
│  • Клиент доволен - получил быстрый первичный ответ            │
└─────────────────────────────────────────────────────────────────┘
```

## Детальный процесс

### 1️⃣ Клиент создает тикет

```python
# handlers.py → create_ticket()
- Создается тикет в БД
- Сообщение отправляется в чат поддержки
- Вызывается send_ai_response_to_client()
```

### 2️⃣ ИИ проверяет условия

```python
# ai_assistant.py → send_ai_response_to_client()
if AI_ENABLED and AI_AUTO_RESPOND:
    if not human_responded:
        # Генерируем ответ
        ai_response = await get_ai_response(message, lang, topic)
        # Отправляем клиенту
        await bot.send_message(user_id, ai_response)
        # Отмечаем что ИИ ответил
        await mark_ai_responded(user_id)
```

### 3️⃣ ИИ генерирует ответ

```python
# ai_assistant.py → get_ai_response()
- Строит промпт с базой знаний FAQ
- Отправляет запрос в OpenAI API
- Получает ответ
- Возвращает текст
```

### 4️⃣ Клиент получает ответ

```
Клиент видит:
┌──────────────────────────────────┐
│ Чтобы пополнить баланс:          │
│ 1. Перейдите в раздел Профиль    │
│ 2. Нажмите кнопку Пополнить      │
│ 3. Выберите способ...            │
└──────────────────────────────────┘

НЕ видит:
❌ "🤖 ИИ-Ассистент"
❌ "Автоматический ответ"
❌ Никаких упоминаний ИИ
```

### 5️⃣ Оператор отвечает

```python
# handlers.py → forward_to_user()
- Сообщение оператора отправляется клиенту
- update_ticket_support_activity(user_id)
- human_responded = TRUE
- ИИ видит флаг и больше не отвечает
```

## Логика отключения ИИ

```python
# В send_ai_response_to_client()
human_responded = await check_if_human_responded(user_id)
if human_responded:
    logger.debug("Human already responded, skipping AI")
    return  # ИИ не отвечает!
```

## База данных

```sql
CREATE TABLE tickets (
    user_id BIGINT PRIMARY KEY,
    thread_id BIGINT,
    status TEXT,
    topic TEXT,
    human_responded BOOLEAN DEFAULT FALSE,  -- Ответил ли оператор
    ai_responded BOOLEAN DEFAULT FALSE      -- Ответил ли ИИ
);
```

## Примеры логов

### Успешная работа ИИ
```
2024-12-26 10:30:15 - AI Assistant initialized with model: gpt-4o-mini
2024-12-26 10:30:20 - Requesting AI response for message: Как пополнить баланс?
2024-12-26 10:30:22 - AI response generated: Чтобы пополнить баланс...
2024-12-26 10:30:22 - AI response sent to user 123456
```

### Оператор ответил
```
2024-12-26 10:35:10 - Human already responded to user 123456, skipping AI
```

### ИИ отключен
```
2024-12-26 10:40:00 - AI is disabled, skipping response generation
```

## Преимущества такой схемы

✅ **Невидимость** - клиент не знает про ИИ  
✅ **Скорость** - ответ за 1-3 секунды  
✅ **Умность** - использует FAQ  
✅ **Плавность** - оператор подключается когда нужно  
✅ **Экономия** - ИИ обрабатывает 70-80% вопросов  
✅ **Контроль** - оператор всегда может вмешаться

## Настройка поведения

### Отключить автоответы
```env
AI_AUTO_RESPOND=false
```
ИИ не будет отвечать автоматически

### Отключить ИИ полностью
```env
AI_ENABLED=false
```
ИИ вообще не работает

### Изменить модель
```env
AI_MODEL=gpt-4o  # Мощнее
AI_MODEL=gpt-4o-mini  # Быстрее и дешевле
```

## Мониторинг

```bash
# Смотреть активность ИИ
tail -f bot.log | grep "AI response sent"

# Смотреть когда операторы отвечают
tail -f bot.log | grep "Human already responded"

# Смотреть все действия ИИ
tail -f bot.log | grep "AI"
```

---

**Итог:** ИИ работает как невидимый помощник, мгновенно отвечая клиентам до тех пор, пока оператор не подключится. Клиенты довольны скоростью, операторы освобождены от рутины! 🎉

